mixin post(sp, i)
  .post(id="post_#{sp.id}", class=(i % 2) ? 'odd' : 'even', data-user-id=sp.user_id, data-post-id=sp.id)
    if sp.title
      h4.title= sp.title
    .profile.photo
      img(src="#{cache_url}/#{sp.user_photo}")
    a.user.mutant(href="/user/#{sp.user_name}")= sp.user_name
    .date(data-time=sp.created_iso)= sp.created_human
    if sp.html
      p.body!= sp.html
    .reply
    mixin actions(sp)
  .children
    if sp.posts.length
      each pp, ii in sp.posts
        mixin post(pp, ii)
    else if sp.morePosts
      a(href='#') Load more posts ...

mixin breadcrumb(p)
  path  = ''
  parts = p.uri.split('/')
  parts = parts.splice(1, parts.length-2)
  each part in parts
    if part != 't'
      a.mutant(href="/#{path}#{part}")= part.replace('-', ' ')
      span /
    - path = path + part + '/'
  em= p.title

mixin actions(p)
  .actions
    a.onclick-append-reply-ui Reply
    a.edit.mutant.no-surf(href="#{p.uri.replace(/\/\d+$/, '')}/edit/#{p.id}") Edit
    a.mutant(href=p.uri) Permalink
    if (typeof(user) !== 'undefined' && user) && user.rights.super
      a.onclick-censor-post Censor

mixin post-edit(p)
  action = p.id && '/'+p.id || ''
  .post-edit.onclick-submit(class=p.is_comment ? 'comment' : '')
    form#post_edit_form(action="/resources/posts#{action}", method="#{p.method || 'put'}")
      if !p.is_comment
        input.title(name='title', type='text', placeholder='Title', value=p.title)
      textarea.body(name='body')= p.body
      input(type='hidden', name='id', value=p.id || 0)
      input(type='hidden', name='forum_id', value=p.forum_id)
      input(type='hidden', name='parent_id', value=p.parent_id)
      input(type='hidden', name='csrf', value=p.csrf)
      input.button(type='submit', value='Save')
      input.button.cancel(type='button', value='Cancel')
    .preview

mixin thread(t)
  li.thread(data-id=t.id, data-user-id=t.user_id)
    a.mutant(href=t.uri)
      h4.title= t.title
      .profile.photo
        img(src="#{cache_url}/#{t.user_photo}")
      .created(data-time=t.created_iso)= t.created_human
      .username by
        em= t.user_name // XXX weird things happened when I tried to turn this into an anchor
      span.post-count= t.post_count
        i posts
      span.views= t.views
        i views

