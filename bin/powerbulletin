#!/bin/bash -e

pid=false
last=0

compile()
{
  echo "Compiling ..."
  ./bin/compile >/dev/null &
  pid=$!
}

control_c()
{ # reap & compile when user hits control-c
  kill -9 $pid # reap

  # re-compile if at least 3-seconds elapsed
  now=`date +%s`
  dif=`expr $now - $last`
  if [ $dif -gt 2 ]; then
    compile; fi
  last=$now
}

cleanup()
{ # cleanup
  kill -9 $pid
}

# main
# ---------
if [ "$NODE_ENV" = production ] ; then
  node_modules/coffee-script/bin/coffee main.coffee 2>> error_log
else
  export WM_NODE_WORKERS=${WM_NODE_WORKERS:=1}

  # trap keyboard interrupt (control-c)
  trap control_c SIGINT SIGTERM
  trap cleanup SIGKILL
  compile
  
  echo "Hit ^C once  to restart."
  echo "Hit ^C twice to quit."
  while true ; do 
    sleep 1
    node_modules/coffee-script/bin/coffee main.coffee
  done
fi
