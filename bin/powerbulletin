#!/bin/bash -e

# main
# ---------
if [ "$NODE_ENV" = 'production' ] ; then
  grunt css procs clientJade componentJade livescript browserify uglify cleanup
  mkdir -p logs

  # varnish setup to handle 3000-3009 for now
  # but we are starting with 3 node processes
  # 1 have 1 vCPU so this isn't necessarily performant
  # but its nice to have backup app processes if one crashes

  killall mon # make sure daemons are monitored for launched processes also
  for port in {3000..3002}
  do
    set +e
    # XXX: it is assumed that the previous mon has been killed by the time you get here
    echo "killing pb-worker-$port..."
    killall "pb-worker-$port"
    sleep 10 # give 10 seconds for graceful death
    killall -9 "pb-worker-$port"
    set -e
    mon -d \
        -l logs/powerbulletin.log \
        -m /tmp/pb.pid \
        "node app/main.js $port"
    sleep 5 # give 5 seconds for process to start up before moving on to next one
  done
else
  export NODE_WORKERS=${NODE_WORKERS:=1}
  # XXX: may want to limit --prof to child process, but don't know api
  # should be good enough for now
  if [ -n "$NODE_PROFILE" ]; then
    args='--prof'; fi
  node $args app/main.js
fi
