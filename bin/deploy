#!/bin/bash -e

# new prod server
TARGET=165.225.139.183

echo deploying to $TARGET...

echo installing git...
ssh root@$TARGET -p 3733 apt-get update -y
ssh root@$TARGET -p 3733 apt-get install git -y

# get deployed source
REMOTE_GIT_COMMAND="
git clone \
  --branch $CI_BRANCH \
  --depth 50 \
  git@github.com:khoerling/powerbulletin.git \
  /pb \
|| (cd /pb; git checkout $CI_BRANCH; git pull)
"
echo updating source...
ssh root@$TARGET -p 3733 $REMOTE_GIT_COMMAND

#echo setting up NODE_ENV=production
# below line doesn't check to see if its there already...
#ssh root@$TARGET 'echo "NODE_ENV=production" >> /etc/environment'

# XXX/TODO: bounce appservers with killall (mon will restart)
echo restarting appservers...
# re-launch daemons + haproxy & varnish after app-servers are restarted
ssh root@$TARGET -p 3733 'cd /pb; bin/launch; bin/powerbulletin'
